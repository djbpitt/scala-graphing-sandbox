<?xml version="1.1" encoding="UTF-8"?><stylesheet xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:cx="http://interedition.eu/collatex/ns/1.0" xmlns:svrl="http://purl.oclc.org/dsdl/svrl" version="3.0" expand-text="false"><variable name="Q{http://dmaus.name/ns/2023/schxslt}phase" as="Q{http://www.w3.org/2001/XMLSchema}string" select="'#ALL'"/><mode use-accumulators=""/><mode name="group.d3e7" on-no-match="shallow-skip" streamable="false" use-accumulators=""/><template match="*" mode="group.d3e7" priority="-10"><apply-templates select="@*" mode="#current"/><apply-templates select="node()" mode="#current"/></template><template match="cx:witness/@siglum" mode="group.d3e7" priority="2"><param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="()"/><variable name="Q{http://dmaus.name/ns/2023/schxslt}rule-context" as="node()" select="."/><choose><when test="'d3e7' = $Q{http://dmaus.name/ns/2023/schxslt}pattern"><svrl:suppresed-rule context="cx:witness/@siglum"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:suppresed-rule><next-match/></when><otherwise><svrl:fired-rule context="cx:witness/@siglum"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:fired-rule><for-each select="."><variable name="my-siglum" select="."/><variable name="my-pos" select="count(../preceding-sibling::cx:witness) + 1"/><variable name="preceding-same-sigla" select="../preceding-sibling::cx:witness[@siglum eq $my-siglum]"/><variable name="preceding-same-sigla-pos" select="$preceding-same-sigla ! count(./preceding-sibling::cx:witness) + 1"/><variable name="following-same-sigla" select="../following-sibling::cx:witness[@siglum eq $my-siglum]"/><variable name="following-same-sigla-pos" select="$following-same-sigla ! (count(preceding-sibling::cx:witness) + 1)"/><if test="empty($preceding-same-sigla) and count($following-same-sigla-pos) ge 1"><variable name="successful-report" as="element(svrl:successful-report)"><svrl:successful-report test="empty($preceding-same-sigla) and count($following-same-sigla-pos) ge 1"><attribute name="location" select="path($Q{http://dmaus.name/ns/2023/schxslt}rule-context)"/><svrl:text> The
        siglum <value-of select="$my-siglum"/> is duplicated at witness offsets: <value-of select="string-join(sort(($my-pos, $preceding-same-sigla-pos, $following-same-sigla-pos)), ', ')"/>. </svrl:text></svrl:successful-report></variable><sequence select="$successful-report"/></if></for-each><next-match><with-param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="('d3e7', $Q{http://dmaus.name/ns/2023/schxslt}pattern)"/></next-match></otherwise></choose></template><template match="cx:witnesses" mode="group.d3e7" priority="1"><param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="()"/><variable name="Q{http://dmaus.name/ns/2023/schxslt}rule-context" as="node()" select="."/><choose><when test="'d3e7' = $Q{http://dmaus.name/ns/2023/schxslt}pattern"><svrl:suppresed-rule context="cx:witnesses"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:suppresed-rule><next-match/></when><otherwise><svrl:fired-rule context="cx:witnesses"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:fired-rule><for-each select="."><variable name="colors" select="cx:witness/@color"/><if test="not(count($colors) = (count(cx:witness), 0))"><variable name="failed-assert" as="element(svrl:failed-assert)"><svrl:failed-assert test="count($colors) = (count(cx:witness), 0)"><attribute name="location" select="path($Q{http://dmaus.name/ns/2023/schxslt}rule-context)"/><svrl:text>There must be @color attributes for
        either all witnesses or no witnesses</svrl:text></svrl:failed-assert></variable><sequence select="$failed-assert"/></if></for-each><next-match><with-param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="('d3e7', $Q{http://dmaus.name/ns/2023/schxslt}pattern)"/></next-match></otherwise></choose></template><template match="cx:witness/@url" mode="group.d3e7" priority="0"><param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="()"/><variable name="Q{http://dmaus.name/ns/2023/schxslt}rule-context" as="node()" select="."/><choose><when test="'d3e7' = $Q{http://dmaus.name/ns/2023/schxslt}pattern"><svrl:suppresed-rule context="cx:witness/@url"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:suppresed-rule><next-match/></when><otherwise><svrl:fired-rule context="cx:witness/@url"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if></svrl:fired-rule><for-each select="."><variable name="my-base-uri" select="string((document-uri(/), base-uri(/))[. ne ''][1])"/><variable name="my-resolved-uri" select="resolve-uri(., $my-base-uri)"/><variable name="preceding-resolved-same-uris" select="           (../preceding-sibling::cx:witness/@url           ! resolve-uri(., $my-base-uri))[. eq $my-resolved-uri]"/><variable name="following-resolved-same-uris-pos" select="           ../following-sibling::cx:witness[           resolve-uri(@url, $my-base-uri) eq $my-resolved-uri           ] ! (count(preceding-sibling::cx:witness) + 1)"/><if test="empty($preceding-resolved-same-uris) and count($following-resolved-same-uris-pos) ge 1"><variable name="successful-report" as="element(svrl:successful-report)"><svrl:successful-report test="empty($preceding-resolved-same-uris) and count($following-resolved-same-uris-pos) ge 1"><attribute name="location" select="path($Q{http://dmaus.name/ns/2023/schxslt}rule-context)"/><svrl:text> The current @url (<value-of select="."/>) is duplicated at witness offsets
          <value-of select="string-join($following-resolved-same-uris-pos, ', ')"/>. </svrl:text></svrl:successful-report></variable><sequence select="$successful-report"/></if><if test="not(unparsed-text-available($my-resolved-uri))"><variable name="failed-assert" as="element(svrl:failed-assert)"><svrl:failed-assert test="unparsed-text-available($my-resolved-uri)"><attribute name="location" select="path($Q{http://dmaus.name/ns/2023/schxslt}rule-context)"/><svrl:text> The url <value-of select="."/> (associated with siglum <value-of select="../@siglum"/> at witness offset
          <value-of select="count(../preceding-sibling::cx:witness) + 1"/>) cannot be resolved.
      </svrl:text></svrl:failed-assert></variable><sequence select="$failed-assert"/></if></for-each><next-match><with-param name="Q{http://dmaus.name/ns/2023/schxslt}pattern" as="Q{http://www.w3.org/2001/XMLSchema}string*" select="('d3e7', $Q{http://dmaus.name/ns/2023/schxslt}pattern)"/></next-match></otherwise></choose></template><template match="root()" as="element(svrl:schematron-output)"><svrl:schematron-output phase="#ALL"><svrl:ns-prefix-in-attribute-values prefix="cx" uri="http://interedition.eu/collatex/ns/1.0"/><!--SchXslt2 Core 1.4.4--><try><svrl:active-pattern><attribute name="documents" select="document-uri(.)"/></svrl:active-pattern><apply-templates select="." mode="group.d3e7"/><catch><svrl:error code="{$Q{http://www.w3.org/2005/xqt-errors}code}"><if test="document-uri()"><attribute name="document" select="document-uri()"/></if><if test="$Q{http://www.w3.org/2005/xqt-errors}description"><value-of select="$Q{http://www.w3.org/2005/xqt-errors}description"/></if></svrl:error><variable name="message" as="Q{http://www.w3.org/2001/XMLSchema}string+" expand-text="yes">
                  Running the ISO Schematron validation failed with a dynamic error.
                  Error code: {$Q{http://www.w3.org/2005/xqt-errors}code} Reason: {$Q{http://www.w3.org/2005/xqt-errors}description}
                </variable><message terminate="yes" error-code="Q{{http://dmaus.name/ns/2023/schxslt}}ValidationError"><text/><value-of select="normalize-space(string-join($message))"/></message></catch></try></svrl:schematron-output></template></stylesheet>